<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Unidades Didácticas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Variables CSS para colores */
        :root {
            --primary-color: #4CAF50; /* Verde principal */
            --primary-dark: #388E3C;
            --secondary-color: #17a2b8; /* Azul cian */
            --secondary-dark: #138496;
            --accent-color: #FFC107; /* Amarillo de acento */
            --accent-dark: #E0A800;
            --danger-color: #DC3545; /* Rojo para eliminar */
            --danger-dark: #C82333;
            --info-color: #007BFF; /* Azul para info/nuevo */
            --info-dark: #0056B3;
            --bg-light: #f8f9fa;
            --bg-medium: #e9ecef;
            --text-dark: #343a40;
            --text-medium: #6c757d;
            --border-color: #dee2e6;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 16px;
        }

        header {
            background-color: var(--primary-color);
            color: white; /* Asegurado a blanco para mayor contraste */
            padding: 25px 0;
            text-align: center;
            box-shadow: 0 4px 8px var(--shadow-medium);
            margin-bottom: 30px;
        }

        header h1 {
            color: white; /* Asegurado a blanco para el h1 dentro del header */
        }

        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 25px;}
        h3 { font-size: 1.4em; color: var(--secondary-dark);}
        h4 { font-size: 1.1em; color: var(--text-dark);}

        main {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 30px;
            max-width: 1500px;
            margin: 0 auto 40px auto; /* Centrar y añadir espacio abajo */
        }

        section {
            background-color: white;
            padding: 35px;
            border-radius: 10px;
            box-shadow: 0 6px 12px var(--shadow-light);
            flex: 1;
            min-width: 480px; /* Ancho mínimo para las columnas */
            box-sizing: border-box;
        }

        #form-section {
            flex: 2; /* Ocupa más espacio para el formulario */
            min-width: 600px; /* Aumentar el ancho mínimo del formulario */
        }

        #list-section {
            flex: 1; /* Ocupa menos espacio para la lista */
        }

        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-medium);
            font-size: 0.95em;
        }

        form input[type="text"],
        form select,
        form input[type="date"] { /* Añadido input[type="date"] */
            width: calc(100% - 22px); /* Ajuste para padding y borde */
            padding: 11px;
            margin-bottom: 18px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        form input[type="text"]:focus,
        form select:focus,
        form input[type="date"]:focus { /* Añadido input[type="date"] */
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            outline: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 18px;
        }

        .form-row > div { /* Contenedor para label y select/input */
            flex: 1;
        }

        .form-row label {
            margin-bottom: 8px;
        }

        .form-row select, .form-row input[type="date"] {
            width: 100%;
        }

        form button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-right: 12px;
            margin-top: 10px;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        form button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        form button:active {
            transform: translateY(0);
        }

        form button#clear-form-btn {
            background-color: var(--info-color);
        }

        form button#clear-form-btn:hover {
            background-color: var(--info-dark);
        }

        /* Sesiones */
        .session-item {
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: var(--bg-medium);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            position: relative; /* Para el contador de sesión */
        }

        .session-item h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--secondary-dark);
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        .session-item input[type="text"],
        .session-item input[type="date"] { /* Añadido input[type="date"] */
            margin-bottom: 12px;
            background-color: white;
        }

        .session-item .remove-session-btn {
            background-color: var(--danger-color);
            float: right;
            margin-top: 5px;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .session-item .remove-session-btn:hover {
            background-color: var(--danger-dark);
        }

        #add-session-btn {
            background-color: var(--secondary-color);
            margin-bottom: 25px;
        }

        #add-session-btn:hover {
            background-color: var(--secondary-dark);
        }

        /* Lista de Unidades */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            padding: 15px;
            background-color: var(--bg-medium);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .filters label {
            font-weight: 600;
            margin-right: 5px;
            color: var(--text-dark);
        }

        .filters select { /* Solo select, ya no input[type="text"] */
            padding: 9px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95em;
            flex-grow: 1; /* Permitir que ocupe espacio */
            min-width: 150px; /* Ancho mínimo para los selectores */
        }

        .filters button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        #apply-filters-btn {
            background-color: var(--text-medium);
            color: white;
        }

        #apply-filters-btn:hover {
            background-color: #5a6268;
        }

        #clear-filters-btn {
            background-color: var(--accent-color);
            color: var(--text-dark);
        }

        #clear-filters-btn:hover {
            background-color: var(--accent-dark);
        }

        .unit-card {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 4px var(--shadow-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .unit-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px var(--shadow-medium);
        }

        .unit-info {
            flex-grow: 1;
        }

        .unit-info h4 {
            margin: 0 0 5px 0;
            color: var(--info-color);
            font-size: 1.15em;
        }

        .unit-info p {
            margin: 0;
            font-size: 0.9em;
            color: var(--text-medium);
        }

        .unit-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unit-actions button {
            padding: 9px 14px;
            font-size: 0.85em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .unit-actions .edit-btn {
            background-color: var(--accent-color);
            color: var(--text-dark);
        }

        .unit-actions .edit-btn:hover {
            background-color: var(--accent-dark);
        }

        .unit-actions .delete-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .unit-actions .delete-btn:hover {
            background-color: var(--danger-dark);
        }

        .unit-actions .print-single-btn {
            background-color: #6f42c1; /* Púrpura */
            color: white;
        }

        .unit-actions .print-single-btn:hover {
            background-color: #5a32a0;
        }

        input[type="checkbox"].unit-select-checkbox {
            transform: scale(1.4);
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--primary-color); /* Color del checkbox */
        }

        .backup-controls, .session-print-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 25px;
            padding: 15px;
            background-color: var(--bg-medium);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            justify-content: space-between;
            align-items: center;
        }
        .session-print-controls h3 {
            width: 100%;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }
        .session-print-controls label {
            font-weight: 600;
            color: var(--text-dark);
            margin-right: 5px;
        }
        .session-print-controls input[type="date"] {
            flex-grow: 1;
            min-width: 180px;
        }


        .backup-controls button, .session-print-controls button {
            padding: 10px 18px;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #export-backup-btn {
            background-color: #28a745;
            color: white;
        }
        #export-backup-btn:hover {
            background-color: #218838;
        }

        #import-backup-btn {
            background-color: var(--accent-color);
            color: var(--text-dark);
        }
        #import-backup-btn:hover {
            background-color: var(--accent-dark);
        }

        #import-file-input {
            display: none; /* Ocultar el input de archivo */
        }

        #print-selected-btn, #export-selected-json-btn {
            background-color: var(--info-color);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            margin-top: 25px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            width: 100%;
            box-shadow: 0 2px 4px var(--shadow-light);
            margin-bottom: 10px; /* Espacio entre botones de acción */
        }

        #print-selected-btn:hover, #export-selected-json-btn:hover {
            background-color: var(--info-dark);
            transform: translateY(-2px);
        }

        #print-week-sessions-btn {
            background-color: #6f42c1; /* Púrpura */
            color: white;
            flex-grow: 1;
        }
        #print-week-sessions-btn:hover {
            background-color: #5a32a0;
        }


        footer {
            text-align: center;
            padding: 25px;
            background-color: var(--text-dark);
            color: white;
            margin-top: 40px;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }

        /* Estilos para el editor de texto enriquecido */
        .rich-text-editor-container {
            margin-bottom: 18px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .rich-text-controls {
            background-color: var(--bg-medium);
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .rich-text-controls button {
            background-color: var(--info-color);
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            min-width: 30px;
        }

        .rich-text-controls button:hover {
            background-color: var(--info-dark);
        }

        .rich-text-content {
            min-height: 80px;
            padding: 11px;
            font-size: 1em;
            line-height: 1.6;
            outline: none;
            background-color: white;
            box-sizing: border-box;
            cursor: text;
        }

        .rich-text-content:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        /* Asegura que el contenedor del editor tenga el borde y la sombra cuando el contenido está enfocado */
        .rich-text-editor-container:has(.rich-text-content:focus) {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        /* Estilos para la impresión */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                box-sizing: border-box;
                font-family: 'Roboto', sans-serif;
                color: #000;
            }

            /* Ocultar botones y checkboxes dentro del contenido imprimible */
            .printable-content .unit-actions,
            .printable-content input[type="checkbox"],
            .printable-content .rich-text-controls { /* Ocultar controles del editor */
                display: none;
            }

            h1, h2, h3, h4 {
                color: #000 !important; /* Asegura que el texto sea negro para impresión */
                font-family: 'Poppins', sans-serif !important;
            }
            h1 { font-size: 2em; text-align: center; margin-bottom: 30px;}
            h2 { font-size: 1.6em; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px;}
            h3 { font-size: 1.3em; color: #333;}
            h4 { font-size: 1.1em; color: #555;}
            p { margin-bottom: 5px; }
            .unit-details {
                border: 1px solid #ddd;
                padding: 25px;
                margin-bottom: 30px;
                page-break-inside: avoid; /* Evita que las unidades se corten entre páginas */
                border-radius: 8px;
                background-color: #fcfcfc;
            }

            .session-group { /* Estilo para agrupar sesiones por día en la impresión semanal */
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px dashed #eee;
            }
            .session-group:last-of-type {
                border-bottom: none;
            }
            .session-group h2 {
                color: #4CAF50;
                font-size: 1.4em;
                margin-top: 15px;
                margin-bottom: 10px;
                border-bottom: none; /* Eliminar borde para este h2 */
            }

            .session-item-print {
                border-left: 5px solid #17a2b8;
                padding-left: 15px;
                margin-top: 15px;
                margin-bottom: 15px;
                background-color: #f5fafd;
                page-break-inside: avoid;
                border-radius: 4px;
            }
            .session-item-print p {
                margin-bottom: 3px;
                font-size: 0.95em;}
            strong { font-weight: 600; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Gestor de Unidades Didácticas para Infantil y Primaria</h1>
    </header>

    <main>
        <section id="form-section">
            <h2>Crear/Editar Unidad/Tema/SDA</h2>
            <form id="unit-form">
                <input type="hidden" id="unit-id">

                <label for="unit-title">Título de la Unidad/Tema/SDA:</label>
                <input type="text" id="unit-title" required>

                <div class="form-row">
                    <div>
                        <label for="unit-course">Curso:</label>
                        <select id="unit-course" required>
                            <option value="">Selecciona un curso</option>
                            <option value="Infantil 3 Años">Infantil 3 Años</option>
                            <option value="Infantil 4 Años">Infantil 4 Años</option>
                            <option value="Infantil 5 Años">Infantil 5 Años</option>
                            <option value="1º Primaria">1º Primaria</option>
                            <option value="2º Primaria">2º Primaria</option>
                            <option value="3º Primaria">3º Primaria</option>
                            <option value="4º Primaria">4º Primaria</option>
                            <option value="5º Primaria">5º Primaria</option>
                            <option value="6º Primaria">6º Primaria</option>
                        </select>
                    </div>
                    <div>
                        <label for="unit-area">Área/Materia:</label>
                        <select id="unit-area" required>
                            <option value="">Selecciona un área</option>
                            <option value="Lengua Castellana y Literatura">Lengua Castellana y Literatura</option>
                            <option value="Matemáticas">Matemáticas</option>
                            <option value="Ciencias de la Naturaleza">Ciencias de la Naturaleza</option>
                            <option value="Ciencias Sociales">Ciencias Sociales</option>
                            <option value="Educación Artística">Educación Artística</option>
                            <option value="Educación Física">Educación Física</option>
                            <option value="Lengua Extranjera (Inglés)">Lengua Extranjera (Inglés)</option>
                            <option value="Valores Sociales y Cívicos">Valores Sociales y Cívicos</option>
                            <option value="Religión">Religión</option>
                            <option value="Educación Emocional">Educación Emocional</option>
                            <option value="Proyectos">Proyectos</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label for="unit-start-date">Fecha de Inicio de la Unidad:</label>
                        <input type="date" id="unit-start-date">
                    </div>
                    <div>
                        <label for="unit-end-date">Fecha de Fin de la Unidad:</label>
                        <input type="date" id="unit-end-date">
                    </div>
                </div>

                <h3>Elementos Curriculares</h3>
                <label for="unit-objectives">Objetivos de Aprendizaje:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-objectives"></div>
                </div>

                <label for="unit-contents">Contenidos (Saberes Básicos):</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-contents"></div>
                </div>

                <label for="unit-evaluation-criteria">Criterios de Evaluación:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-evaluation-criteria"></div>
                </div>

                <label for="unit-key-competences">Competencias Clave:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-key-competences"></div>
                </div>

                <label for="unit-methodology">Metodología/Estrategias Didácticas:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-methodology"></div>
                </div>

                <label for="unit-attention-diversity">Atención a la Diversidad:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-attention-diversity"></div>
                </div>

                <label for="unit-materials">Recursos y Materiales:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-materials"></div>
                </div>

                <label for="unit-assessment-instruments">Instrumentos de Evaluación:</label>
                <div class="rich-text-editor-container">
                    <div class="rich-text-controls">
                        <button type="button" data-command="bold"><b>B</b></button>
                        <button type="button" data-command="italic"><i>I</i></button>
                        <button type="button" data-command="underline"><u>U</u></button>
                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                    <div contenteditable="true" class="rich-text-content" id="unit-assessment-instruments"></div>
                </div>

                <h3>Desarrollo de Sesiones</h3>
                <div id="sessions-container">
                </div>
                <button type="button" id="add-session-btn">Añadir Sesión</button>

                <button type="submit">Guardar Unidad</button>
                <button type="button" id="clear-form-btn">Nueva Unidad/Limpiar</button>
            </form>
        </section>

        <section id="list-section">
            <h2>Mis Unidades Guardadas</h2>

            <div class="filters">
                <label for="filter-course">Filtrar por Curso:</label>
                <select id="filter-course">
                    <option value="">Todos los Cursos</option>
                    <option value="Infantil 3 Años">Infantil 3 Años</option>
                    <option value="Infantil 4 Años">Infantil 4 Años</option>
                    <option value="Infantil 5 Años">Infantil 5 Años</option>
                    <option value="1º Primaria">1º Primaria</option>
                    <option value="2º Primaria">2º Primaria</option>
                    <option value="3º Primaria">3º Primaria</option>
                    <option value="4º Primaria">4º Primaria</option>
                    <option value="5º Primaria">5º Primaria</option>
                    <option value="6º Primaria">6º Primaria</option>
                </select>

                <label for="filter-area">Filtrar por Área:</label>
                <select id="filter-area">
                    <option value="">Todas las Áreas</option>
                    <option value="Lengua Castellana y Literatura">Lengua Castellana y Literatura</option>
                    <option value="Matemáticas">Matemáticas</option>
                    <option value="Ciencias de la Naturaleza">Ciencias de la Naturaleza</option>
                    <option value="Ciencias Sociales">Ciencias Sociales</option>
                    <option value="Educación Artística">Educación Artística</option>
                    <option value="Educación Física">Educación Física</option>
                    <option value="Lengua Extranjera (Inglés)">Lengua Extranjera (Inglés)</option>
                    <option value="Valores Sociales y Cívicos">Valores Sociales y Cívicos</option>
                    <option value="Religión">Religión</option>
                    <option value="Educación Emocional">Educación Emocional</option>
                    <option value="Proyectos">Proyectos</option>
                    <option value="Otros">Otros</option>
                </select>

                <button id="apply-filters-btn">Aplicar Filtros</button>
                <button id="clear-filters-btn">Borrar Filtros</button>
            </div>

            <div id="unit-list">
            </div>

            <button id="print-selected-btn">Imprimir Unidades Seleccionadas</button>
            <button id="export-selected-json-btn">Exportar Unidades Seleccionadas (JSON)</button>

            <div class="session-print-controls">
                <h3>Imprimir Sesiones por Semana</h3>
                <label for="week-session-date">Selecciona una fecha en la semana:</label>
                <input type="date" id="week-session-date">
                <button id="print-week-sessions-btn">Imprimir Sesiones de esta Semana</button>
            </div>

            <div class="backup-controls">
                <button id="export-backup-btn">Exportar Todas las Unidades (Backup)</button>
                <input type="file" id="import-file-input" accept=".json">
                <button id="import-backup-btn">Importar Unidades (Backup)</button>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Creador de Unidades Didácticas. Desarrollado para docentes.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const unitForm = document.getElementById('unit-form');
            const unitIdInput = document.getElementById('unit-id');
            const unitTitleInput = document.getElementById('unit-title');
            const unitCourseSelect = document.getElementById('unit-course');
            const unitAreaSelect = document.getElementById('unit-area');
            const unitStartDateInput = document.getElementById('unit-start-date');
            const unitEndDateInput = document.getElementById('unit-end-date');

            // Rich text editor elements
            const unitObjectivesEditor = document.getElementById('unit-objectives');
            const unitContentsEditor = document.getElementById('unit-contents');
            const unitEvaluationCriteriaEditor = document.getElementById('unit-evaluation-criteria');
            const unitKeyCompetencesEditor = document.getElementById('unit-key-competences');
            const unitMethodologyEditor = document.getElementById('unit-methodology');
            const unitAttentionDiversityEditor = document.getElementById('unit-attention-diversity');
            const unitMaterialsEditor = document.getElementById('unit-materials');
            const unitAssessmentInstrumentsEditor = document.getElementById('unit-assessment-instruments');

            const sessionsContainer = document.getElementById('sessions-container');
            const addSessionBtn = document.getElementById('add-session-btn');
            const clearFormBtn = document.getElementById('clear-form-btn');

            const filterCourseSelect = document.getElementById('filter-course');
            const filterAreaSelect = document.getElementById('filter-area');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const unitListDiv = document.getElementById('unit-list');
            const printSelectedBtn = document.getElementById('print-selected-btn');
            const exportSelectedJsonBtn = document.getElementById('export-selected-json-btn');

            const weekSessionDateInput = document.getElementById('week-session-date');
            const printWeekSessionsBtn = document.getElementById('print-week-sessions-btn');

            const exportBackupBtn = document.getElementById('export-backup-btn');
            const importFileInput = document.getElementById('import-file-input');
            const importBackupBtn = document.getElementById('import-backup-btn');

            let units = JSON.parse(localStorage.getItem('units')) || [];
            let currentEditUnitId = null;

            // Helper functions for date manipulation
            function getMonday(d) {
                // Asegura que la fecha se trate como el inicio del día local
                d = new Date(d + 'T00:00:00');
                // 0 para Domingo, 1 para Lunes, ..., 6 para Sábado
                const day = d.getDay();
                // Ajustar para Domingo (0) para obtener el Lunes de la semana anterior
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }

            function getFriday(d) {
                const monday = getMonday(d);
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4); // Lunes + 4 días = Viernes
                return friday;
            }

            function formatDateToISO(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDateDisplay(dateString) {
                if (!dateString) return 'N/A';
                // Añadir T00:00:00 para evitar problemas de zona horaria
                const date = new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return 'N/A'; // Comprobar fecha inválida
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            /**
             * Aplica un comando de edición de texto enriquecido al documento.
             * @param {string} command - El comando a ejecutar (ej. 'bold', 'italic', 'underline', 'createLink').
             * @param {string} [value=null] - El valor asociado al comando (ej. URL para 'createLink').
             */
            const applyRichTextCommand = (command, value = null) => {
                if (command === 'createLink') {
                    const url = prompt('Introduce la URL del hipervínculo:');
                    if (url) {
                        document.execCommand(command, false, url);
                    }
                } else {
                    document.execCommand(command, false, value);
                }
            };

            /**
             * Configura un editor de texto enriquecido para un elemento dado.
             * Asocia los botones de control con las acciones de edición.
             * @param {string} elementId - El ID del elemento `contenteditable` a configurar.
             */
            const setupRichTextEditor = (elementId) => {
                const editorElement = document.getElementById(elementId);
                if (!editorElement) return;

                // Asumiendo que los controles están justo antes del editor
                const controlsContainer = editorElement.previousElementSibling;
                if (controlsContainer && controlsContainer.classList.contains('rich-text-controls')) {
                    controlsContainer.querySelectorAll('button[data-command]').forEach(button => {
                        button.addEventListener('click', () => {
                            editorElement.focus(); // Enfocar el editor antes de aplicar el comando
                            // Para el comando createLink, no pasamos un valor inicial, ya que el prompt lo obtendrá
                            applyRichTextCommand(button.dataset.command, button.dataset.value || null);
                        });
                    });
                }
            };

            // Función para añadir una sesión al formulario
            const addSessionField = (session = {}) => {
                const sessionId = session.id || Date.now().toString();
                const sessionDiv = document.createElement('div');
                sessionDiv.classList.add('session-item');
                sessionDiv.dataset.sessionId = sessionId;

                sessionDiv.innerHTML = `
                    <h4>Sesión <span class="session-number"></span></h4>
                    <label>Fecha de la Sesión:</label>
                    <input type="date" class="session-date" value="${session.sessionDate || ''}" required>
                    <label>Título de la Sesión:</label>
                    <input type="text" class="session-title" value="${session.title || ''}" required>

                    <label for="session-description-${sessionId}">Descripción y Actividades:</label>
                    <div class="rich-text-editor-container">
                        <div class="rich-text-controls">
                            <button type="button" data-command="bold"><b>B</b></button>
                            <button type="button" data-command="italic"><i>I</i></button>
                            <button type="button" data-command="underline"><u>U</u></button>
                            <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                            <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                            <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                        <div contenteditable="true" class="rich-text-content" id="session-description-${sessionId}">${session.description || ''}</div>
                    </div>

                    <label>Materiales y Recursos:</label>
                    <input type="text" class="session-materials" value="${session.materials || ''}">
                    <label>Tiempo estimado:</label>
                    <input type="text" class="session-time" value="${session.time || ''}">

                    <label for="session-evaluation-${sessionId}">Evaluación de la Sesión:</label>
                    <div class="rich-text-editor-container">
                        <div class="rich-text-controls">
                            <button type="button" data-command="bold"><b>B</b></button>
                            <button type="button" data-command="italic"><i>I</i></button>
                            <button type="button" data-command="underline"><u>U</u></button>
                            <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                            <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                            <button type="button" data-command="createLink"><i class="fas fa-link"></i></button> </div>
                        <div contenteditable="true" class="rich-text-content" id="session-evaluation-${sessionId}">${session.evaluation || ''}</div>
                    </div>

                    <button type="button" class="remove-session-btn">Eliminar Sesión</button>
                `;
                sessionsContainer.appendChild(sessionDiv);

                // Configurar los editores de texto enriquecido para la sesión recién añadida
                setupRichTextEditor(`session-description-${sessionId}`);
                setupRichTextEditor(`session-evaluation-${sessionId}`);

                sessionDiv.querySelector('.remove-session-btn').addEventListener('click', () => {
                    sessionDiv.remove();
                    updateSessionNumbers();
                });
                updateSessionNumbers();
            };

            // Actualizar los números de las sesiones
            const updateSessionNumbers = () => {
                const sessionItems = sessionsContainer.querySelectorAll('.session-item');
                sessionItems.forEach((item, index) => {
                    item.querySelector('.session-number').textContent = index + 1;
                });
            };

            // Cargar los datos de una unidad para edición
            const loadUnitForEdit = (unitId) => {
                const unit = units.find(u => u.id === unitId);
                if (unit) {
                    currentEditUnitId = unitId;
                    unitIdInput.value = unit.id;
                    unitTitleInput.value = unit.title;
                    unitCourseSelect.value = unit.course;
                    unitAreaSelect.value = unit.area;
                    unitStartDateInput.value = unit.startDate || '';
                    unitEndDateInput.value = unit.endDate || '';

                    // Cargar contenido HTML en los editores de texto enriquecido
                    unitObjectivesEditor.innerHTML = unit.objectives || '';
                    unitContentsEditor.innerHTML = unit.contents || '';
                    unitEvaluationCriteriaEditor.innerHTML = unit.evaluationCriteria || '';
                    unitKeyCompetencesEditor.innerHTML = unit.keyCompetences || '';
                    unitMethodologyEditor.innerHTML = unit.methodology || '';
                    unitAttentionDiversityEditor.innerHTML = unit.attentionDiversity || '';
                    unitMaterialsEditor.innerHTML = unit.materials || '';
                    unitAssessmentInstrumentsEditor.innerHTML = unit.assessmentInstruments || '';

                    sessionsContainer.innerHTML = '';
                    unit.sessions.forEach(session => addSessionField(session));
                }
            };

            // Guardar o actualizar una unidad
            unitForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const sessions = [];
                sessionsContainer.querySelectorAll('.session-item').forEach(sessionDiv => {
                    // Obtener el contenido HTML de los editores de sesión
                    sessions.push({
                        id: sessionDiv.dataset.sessionId,
                        sessionDate: sessionDiv.querySelector('.session-date').value,
                        title: sessionDiv.querySelector('.session-title').value,
                        description: sessionDiv.querySelector(`#session-description-${sessionDiv.dataset.sessionId}`).innerHTML,
                        materials: sessionDiv.querySelector('.session-materials').value,
                        time: sessionDiv.querySelector('.session-time').value,
                        evaluation: sessionDiv.querySelector(`#session-evaluation-${sessionDiv.dataset.sessionId}`).innerHTML
                    });
                });

                const newUnit = {
                    id: unitIdInput.value || Date.now().toString(),
                    title: unitTitleInput.value,
                    course: unitCourseSelect.value,
                    area: unitAreaSelect.value,
                    startDate: unitStartDateInput.value,
                    endDate: unitEndDateInput.value,
                    // Obtener contenido HTML de los editores principales
                    objectives: unitObjectivesEditor.innerHTML,
                    contents: unitContentsEditor.innerHTML,
                    evaluationCriteria: unitEvaluationCriteriaEditor.innerHTML,
                    keyCompetences: unitKeyCompetencesEditor.innerHTML,
                    methodology: unitMethodologyEditor.innerHTML,
                    attentionDiversity: unitAttentionDiversityEditor.innerHTML,
                    materials: unitMaterialsEditor.innerHTML,
                    assessmentInstruments: unitAssessmentInstrumentsEditor.innerHTML,
                    sessions: sessions
                };

                if (currentEditUnitId) {
                    units = units.map(unit => unit.id === currentEditUnitId ? newUnit : unit);
                    currentEditUnitId = null;
                } else {
                    units.push(newUnit);
                }

                localStorage.setItem('units', JSON.stringify(units));
                // Reemplazar alert con un mensaje en la UI si es posible, o mantener por simplicidad
                // Para este entorno, alert es aceptable si no hay una UI de mensajes definida.
                alert('¡Unidad guardada exitosamente!');
                clearForm();
                renderUnits();
            });

            // Limpiar el formulario
            const clearForm = () => {
                unitIdInput.value = '';
                unitForm.reset();
                // Limpiar contenido de los editores de texto enriquecido
                unitObjectivesEditor.innerHTML = '';
                unitContentsEditor.innerHTML = '';
                unitEvaluationCriteriaEditor.innerHTML = '';
                unitKeyCompetencesEditor.innerHTML = '';
                unitMethodologyEditor.innerHTML = '';
                unitAttentionDiversityEditor.innerHTML = '';
                unitMaterialsEditor.innerHTML = '';
                unitAssessmentInstrumentsEditor.innerHTML = '';

                sessionsContainer.innerHTML = '';
                addSessionField(); // Añadir una sesión inicial limpia
                currentEditUnitId = null;
                unitStartDateInput.value = '';
                unitEndDateInput.value = '';
            };

            // Función para renderizar las unidades en la lista
            const renderUnits = (filteredUnits = units) => {
                unitListDiv.innerHTML = '';
                if (filteredUnits.length === 0) {
                    unitListDiv.innerHTML = '<p>No hay unidades guardadas o que coincidan con los filtros.</p>';
                    return;
                }

                filteredUnits.forEach(unit => {
                    const unitCard = document.createElement('div');
                    unitCard.classList.add('unit-card');
                    unitCard.dataset.unitId = unit.id;

                    unitCard.innerHTML = `
                        <input type="checkbox" class="unit-select-checkbox" data-unit-id="${unit.id}">
                        <div class="unit-info">
                            <h4>${unit.title}</h4>
                            <p><strong>Curso:</strong> ${unit.course} | <strong>Área:</strong> ${unit.area}</p>
                            ${unit.startDate && unit.endDate ? `<p><strong>Fechas:</strong> ${formatDateDisplay(unit.startDate)} - ${formatDateDisplay(unit.endDate)}</p>` : ''}
                        </div>
                        <div class="unit-actions">
                            <button class="edit-btn" data-id="${unit.id}">Editar</button>
                            <button class="delete-btn" data-id="${unit.id}">Eliminar</button>
                            <button class="print-single-btn" data-id="${unit.id}">Imprimir</button>
                        </div>
                    `;
                    unitListDiv.appendChild(unitCard);
                });

                unitListDiv.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const unitId = e.target.dataset.id;
                        loadUnitForEdit(unitId);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                });

                unitListDiv.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const unitId = e.target.dataset.id;
                        // Reemplazar confirm con un modal en la UI si es posible
                        if (confirm('¿Estás seguro de que quieres eliminar esta unidad?')) {
                            units = units.filter(unit => unit.id !== unitId);
                            localStorage.setItem('units', JSON.stringify(units));
                            renderUnits(applyFilters());
                        }
                    });
                });

                unitListDiv.querySelectorAll('.print-single-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const unitId = e.target.dataset.id;
                        printUnits([unitId]);
                    });
                });
            };

            // Función para aplicar filtros (para unidades)
            const applyFilters = () => {
                const selectedCourse = filterCourseSelect.value;
                const selectedArea = filterAreaSelect.value;

                return units.filter(unit => {
                    const matchesCourse = selectedCourse === '' || unit.course === selectedCourse;
                    const matchesArea = selectedArea === '' || unit.area === selectedArea;
                    return matchesCourse && matchesArea;
                });
            };

            // Función para imprimir unidades completas
            const printUnits = (unitIdsToPrint) => {
                const unitsToPrint = units.filter(unit => unitIdsToPrint.includes(unit.id));

                if (unitsToPrint.length === 0) {
                    alert('No hay unidades seleccionadas para imprimir.');
                    return;
                }

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="es">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Impresión de Unidades Didácticas</title>
                        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; color: #000; font-size: 14px; }
                            h1, h2, h3, h4 { font-family: 'Poppins', sans-serif; color: #2e7d32; margin-top: 20px; margin-bottom: 10px; }
                            h1 { font-size: 2em; text-align: center; margin-bottom: 30px;}
                            h2 { font-size: 1.6em; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px;}
                            h3 { font-size: 1.3em; color: #333;}
                            h4 { font-size: 1.1em; color: #555;}
                            p { margin-bottom: 5px; }
                            .unit-details { border: 1px solid #ddd; padding: 25px; margin-bottom: 30px; page-break-inside: avoid; border-radius: 8px; background-color: #fcfcfc;}
                            .session-print-item { border-left: 5px solid #17a2b8; padding-left: 15px; margin-top: 15px; margin-bottom: 15px; background-color: #f5fafd; page-break-inside: avoid; border-radius: 4px;}
                            .session-print-item p { margin-bottom: 3px; font-size: 0.95em;}
                            strong { font-weight: 600; }
                        </style>
                    </head>
                    <body>
                        <div class="printable-content">
                            <h1>Unidades Didácticas para Imprimir</h1>
                `);

                unitsToPrint.forEach(unit => {
                    printWindow.document.write(`
                        <div class="unit-details">
                            <h2>${unit.title}</h2>
                            <p><strong>Curso:</strong> ${unit.course}</p>
                            <p><strong>Área:</strong> ${unit.area}</p>
                            ${unit.startDate && unit.endDate ? `<p><strong>Fechas:</strong> ${formatDateDisplay(unit.startDate)} - ${formatDateDisplay(unit.endDate)}</p>` : ''}
                            <p><strong>Objetivos de Aprendizaje:</strong> ${unit.objectives || 'N/A'}</p>
                            <p><strong>Contenidos (Saberes Básicos):</strong> ${unit.contents || 'N/A'}</p>
                            <p><strong>Criterios de Evaluación:</strong> ${unit.evaluationCriteria || 'N/A'}</p>
                            <p><strong>Competencias Clave:</strong> ${unit.keyCompetences || 'N/A'}</p>
                            <p><strong>Metodología/Estrategias Didácticas:</strong> ${unit.methodology || 'N/A'}</p>
                            <p><strong>Atención a la Diversidad:</strong> ${unit.attentionDiversity || 'N/A'}</p>
                            <p><strong>Recursos y Materiales:</strong> ${unit.materials || 'N/A'}</p>
                            <p><strong>Instrumentos de Evaluación:</strong> ${unit.assessmentInstruments || 'N/A'}</p>

                            <h3>Desarrollo de Sesiones:</h3>
                    `);
                    if (unit.sessions && unit.sessions.length > 0) {
                        unit.sessions.forEach((session, index) => {
                            printWindow.document.write(`
                                <div class="session-print-item">
                                    <h4>Sesión ${index + 1}: ${session.title || 'Sin Título'} (${formatDateDisplay(session.sessionDate)})</h4>
                                    <p><strong>Descripción:</strong> ${session.description || 'N/A'}</p>
                                    <p><strong>Materiales:</strong> ${session.materials || 'N/A'}</p>
                                    <p><strong>Tiempo:</strong> ${session.time || 'N/A'}</p>
                                    <p><strong>Evaluación:</strong> ${session.evaluation || 'N/A'}</p>
                                </div>
                            `);
                        });
                    } else {
                        printWindow.document.write('<p>No hay sesiones definidas para esta unidad.</p>');
                    }
                    printWindow.document.write(`</div>`);
                });

                printWindow.document.write(`
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };

            // Función para imprimir sesiones de una semana específica
            const printSessionsForSpecificWeek = (dateString) => {
                const monday = getMonday(dateString);
                const friday = getFriday(dateString);

                const mondayISO = formatDateToISO(monday);
                const fridayISO = formatDateToISO(friday);

                let sessionsToPrint = [];

                units.forEach(unit => {
                    unit.sessions.forEach(session => {
                        if (session.sessionDate) {
                            const currentSessionDate = new Date(session.sessionDate + 'T00:00:00');
                            // Comprobar si la fecha de la sesión está dentro del rango de Lunes a Viernes (inclusive)
                            if (currentSessionDate >= monday && currentSessionDate <= friday) {
                                sessionsToPrint.push({
                                    unitTitle: unit.title,
                                    unitCourse: unit.course,
                                    unitArea: unit.area,
                                    session: session
                                });
                            }
                        }
                    });
                });

                if (sessionsToPrint.length === 0) {
                    alert(`No se encontraron sesiones para la semana del ${formatDateDisplay(mondayISO)} al ${formatDateDisplay(fridayISO)}.`);
                    return;
                }

                // Ordenar sesiones por fecha y luego por título de unidad para una mejor legibilidad
                sessionsToPrint.sort((a, b) => {
                    const dateA = new Date(a.session.sessionDate + 'T00:00:00');
                    const dateB = new Date(b.session.sessionDate + 'T00:00:00');
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA.getTime() - dateB.getTime();
                    }
                    return a.unitTitle.localeCompare(b.unitTitle);
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="es">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Sesiones de la Semana: ${formatDateDisplay(mondayISO)} - ${formatDateDisplay(fridayISO)}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; color: #000; font-size: 14px; }
                            h1, h2, h3, h4 { font-family: 'Poppins', sans-serif; color: #2e7d32; margin-top: 20px; margin-bottom: 10px; }
                            h1 { font-size: 2em; text-align: center; margin-bottom: 30px;}
                            h2 { font-size: 1.6em; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px;}
                            h3 { font-size: 1.3em; color: #333;}
                            h4 { font-size: 1.1em; color: #555;}
                            p { margin-bottom: 5px; }
                            .session-group { /* Estilo para agrupar sesiones por día en la impresión semanal */
                                margin-bottom: 20px;
                                padding-bottom: 10px;
                                border-bottom: 1px dashed #eee;
                            }
                            .session-group:last-of-type {
                                border-bottom: none;
                            }
                            .session-group h2 {
                                color: #4CAF50;
                                font-size: 1.4em;
                                margin-top: 15px;
                                margin-bottom: 10px;
                                border-bottom: none; /* Eliminar borde para este h2 */
                            }
                            .session-item-print { border-left: 5px solid #17a2b8; padding-left: 15px; margin-top: 15px; margin-bottom: 15px; background-color: #f5fafd; page-break-inside: avoid; border-radius: 4px;}
                            .session-item-print p { margin-bottom: 3px; font-size: 0.95em;}
                            strong { font-weight: 600; }
                        </style>
                    </head>
                    <body>
                        <div class="printable-content">
                            <h1>Sesiones de la Semana: ${formatDateDisplay(mondayISO)} - ${formatDateDisplay(fridayISO)}</h1>
                `);

                // Agrupar sesiones por fecha para la impresión
                const sessionsByDate = sessionsToPrint.reduce((acc, item) => {
                    const date = item.session.sessionDate;
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(item);
                    return acc;
                }, {});

                const sortedDates = Object.keys(sessionsByDate).sort();

                sortedDates.forEach(date => {
                    printWindow.document.write(`<div class="session-group"><h2>Sesiones del ${formatDateDisplay(date)}</h2>`);
                    sessionsByDate[date].forEach(item => {
                        const session = item.session;
                        printWindow.document.write(`
                            <div class="session-item-print">
                                <h4>Unidad: ${item.unitTitle} (Curso: ${item.unitCourse}, Área: ${item.unitArea})</h4>
                                <h3>Sesión: ${session.title || 'Sin Título'}</h3>
                                <p><strong>Descripción:</strong> ${session.description || 'N/A'}</p>
                                <p><strong>Materiales:</strong> ${session.materials || 'N/A'}</p>
                                <p><strong>Tiempo:</strong> ${session.time || 'N/A'}</p>
                                <p><strong>Evaluación:</strong> ${session.evaluation || 'N/A'}</p>
                            </div>
                        `);
                    });
                    printWindow.document.write(`</div>`);
                });


                printWindow.document.write(`
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };

            // Función para exportar todas las unidades como un archivo JSON de backup
            const exportBackup = () => {
                const dataStr = JSON.stringify(units, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `unidades_didacticas_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('¡Backup de unidades exportado exitosamente!');
            };

            // Función para importar unidades desde un archivo JSON
            const importBackup = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData) && importedData.every(item => typeof item === 'object' && item !== null && 'id' in item && 'title' in item)) {
                            // Reemplazar confirm con un modal en la UI si es posible
                            if (confirm('¿Estás seguro de que quieres importar estas unidades? Esto reemplazará tus unidades actuales.')) {
                                units = importedData;
                                localStorage.setItem('units', JSON.stringify(units));
                                alert('¡Unidades importadas exitosamente!');
                                renderUnits();
                                clearForm();
                            }
                        } else {
                            alert('Error: El archivo JSON no parece contener un formato válido de unidades didácticas.');
                        }
                    } catch (error) {
                        console.error('Error al parsear el archivo JSON:', error);
                        alert('Error al importar el archivo. Asegúrate de que sea un archivo JSON válido.');
                    }
                };
                reader.readAsText(file);
            };

            // Función para exportar solo las unidades seleccionadas como JSON
            const exportSelectedUnitsToJson = () => {
                const selectedUnitIds = Array.from(document.querySelectorAll('.unit-select-checkbox:checked'))
                                             .map(checkbox => checkbox.dataset.unitId);

                if (selectedUnitIds.length === 0) {
                    alert('Por favor, selecciona al menos una unidad para exportar.');
                    return;
                }

                const unitsToExport = units.filter(unit => selectedUnitIds.includes(unit.id));
                const dataStr = JSON.stringify(unitsToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `unidades_seleccionadas_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('¡Unidades seleccionadas exportadas exitosamente!');
            };

            // Event Listeners
            clearFormBtn.addEventListener('click', clearForm);
            addSessionBtn.addEventListener('click', () => addSessionField());
            applyFiltersBtn.addEventListener('click', () => {
                const filtered = applyFilters();
                renderUnits(filtered);
            });
            clearFiltersBtn.addEventListener('click', () => {
                filterCourseSelect.value = '';
                filterAreaSelect.value = '';
                renderUnits();
            });
            exportBackupBtn.addEventListener('click', exportBackup);
            importBackupBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importBackup);
            exportSelectedJsonBtn.addEventListener('click', exportSelectedUnitsToJson);
            printSelectedBtn.addEventListener('click', () => {
                const selectedUnitIds = Array.from(document.querySelectorAll('.unit-select-checkbox:checked'))
                                             .map(checkbox => checkbox.dataset.unitId);
                printUnits(selectedUnitIds);
            });
            printWeekSessionsBtn.addEventListener('click', () => {
                const selectedDate = weekSessionDateInput.value;
                if (!selectedDate) {
                    alert('Por favor, selecciona una fecha para imprimir las sesiones de la semana.');
                    return;
                }
                printSessionsForSpecificWeek(selectedDate);
            });

            // Initial calls
            addSessionField(); // Añadir la primera sesión al cargar
            renderUnits(); // Renderizar las unidades existentes

            // Configurar los editores de texto enriquecido para los campos estáticos
            setupRichTextEditor('unit-objectives');
            setupRichTextEditor('unit-contents');
            setupRichTextEditor('unit-evaluation-criteria');
            setupRichTextEditor('unit-key-competences');
            setupRichTextEditor('unit-methodology');
            setupRichTextEditor('unit-attention-diversity');
            setupRichTextEditor('unit-materials');
            setupRichTextEditor('unit-assessment-instruments');
        });
    </script>
</body>
</html>
